# Инструкция по настройке

## Настройка OpenRouter API

Приложение использует **OpenRouter API** для текстовых ответов и генерации экспертов. OpenRouter поддерживает множество моделей, включая Claude от Anthropic.

1. Зарегистрируйтесь на [OpenRouter](https://openrouter.ai/)

2. Получите API ключ:
   - Перейдите в раздел API Keys
   - Создайте новый API ключ
   - Скопируйте ключ для использования в приложении

**Примечание:** OpenRouter позволяет использовать различные модели. По умолчанию приложение использует `anthropic/claude-3-haiku:beta`. Вы можете изменить модель в настройках пользователя или глобально через администратора.

3. Создайте файл `.env` в корне проекта:
```
SECRET_KEY=ваш-секретный-ключ
DATABASE_URL=sqlite:///ai_bot.db
OPENROUTER_API_KEY=ваш-openrouter-api-ключ

# Настройки email для отправки кодов подтверждения
MAIL_SERVER=smtp.gmail.com
MAIL_PORT=587
MAIL_USE_TLS=true
MAIL_USERNAME=ваш-email@gmail.com
MAIL_PASSWORD=ваш-пароль-приложения

# OAuth (опционально, для входа через GitHub и Google)
GITHUB_CLIENT_ID=ваш-github-client-id
GITHUB_CLIENT_SECRET=ваш-github-client-secret
GOOGLE_CLIENT_ID=ваш-google-client-id
GOOGLE_CLIENT_SECRET=ваш-google-client-secret
```

## Настройка отправки email

Для отправки кодов подтверждения на email необходимо настроить SMTP сервер.

### Настройка Gmail

1. **Включите двухфакторную аутентификацию** в вашем Google аккаунте:
   - Перейдите в [Настройки безопасности Google](https://myaccount.google.com/security)
   - Включите двухфакторную аутентификацию

2. **Создайте пароль приложения:**
   - Перейдите в [Пароли приложений](https://myaccount.google.com/apppasswords)
   - Выберите "Почта" и "Другое устройство"
   - Введите название: "AI Bot"
   - Скопируйте сгенерированный 16-символьный пароль

3. **Добавьте в `.env` файл:**
   ```
   MAIL_SERVER=smtp.gmail.com
   MAIL_PORT=587
   MAIL_USE_TLS=true
   MAIL_USERNAME=ваш-email@gmail.com
   MAIL_PASSWORD=ваш-16-символьный-пароль-приложения
   MAIL_DEFAULT_SENDER=ваш-email@gmail.com
   ```

### Настройка других почтовых сервисов

**Yandex Mail:**
```
MAIL_SERVER=smtp.yandex.ru
MAIL_PORT=465
MAIL_USE_SSL=true
MAIL_USERNAME=ваш-email@yandex.ru
MAIL_PASSWORD=ваш-пароль-приложения
```

**Mail.ru:**
```
MAIL_SERVER=smtp.mail.ru
MAIL_PORT=465
MAIL_USE_SSL=true
MAIL_USERNAME=ваш-email@mail.ru
MAIL_PASSWORD=ваш-пароль-приложения
```

**Примечание:** Если email не настроен, коды подтверждения будут выводиться в консоль сервера (для разработки).

## Запуск приложения

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Запустите приложение:
```bash
python app.py
```

3. Откройте браузер и перейдите на `http://localhost:5000`

## Первый вход

Используйте учетные данные администратора:
- Email: `admin@example.com`
- Пароль: `admin123`

**Важно:** После первого входа измените пароль администратора!

## Создание первого эксперта

1. Войдите как администратор
2. Перейдите в "Управление экспертами"
3. Создайте эксперта, указав:
   - Имя эксперта
   - Описание (например: "Опытный преподаватель математики, который объясняет сложные темы простым языком")

Система автоматически сгенерирует промпт и описание аватара с помощью Yandex GPT.

## Создание первого предмета

1. Войдите как администратор
2. Перейдите в "Управление предметами"
3. Добавьте предмет (например: "Математика", "Физика", "История")

## Настройка входа через GitHub

1. Перейдите на [GitHub Developer Settings](https://github.com/settings/developers)

2. Создайте новое OAuth App:
   - Application name: "AI Bot"
   - Homepage URL: укажите ваш домен (для разработки: http://localhost:5000)
   - Authorization callback URL: `http://localhost:5000/oauth/github/callback`

3. Получите Client ID и Client Secret:
   - Client ID (это ваш `GITHUB_CLIENT_ID`)
   - Client Secret (это ваш `GITHUB_CLIENT_SECRET`)

4. Настройте URL для OAuth:
   - Homepage URL: `http://localhost:5000` (для разработки)
   - Authorization callback URL: `http://localhost:5000/oauth/github/callback`
   - Для продакшена замените `localhost:5000` на ваш домен

5. Добавьте ключи в `.env`:
   ```
   GITHUB_CLIENT_ID=ваш-github-client-id
   GITHUB_CLIENT_SECRET=ваш-github-client-secret
   ```

6. Перезапустите приложение

**Примечание:** Для работы OAuth приложение должно быть доступно по HTTPS в продакшене. Для локальной разработки можно использовать `localhost`.

## Настройка входа через Google (опционально)

1. Перейдите в [Google Cloud Console](https://console.cloud.google.com/)

2. Создайте новый проект или выберите существующий

3. Включите Google+ API:
   - Перейдите в "APIs & Services" → "Library"
   - Найдите "Google+ API" и включите его

4. Создайте OAuth 2.0 credentials:
   - Перейдите в "APIs & Services" → "Credentials"
   - Нажмите "Create Credentials" → "OAuth client ID"
   - Выберите тип "Web application"
   - Добавьте Authorized redirect URIs: `http://localhost:5000/oauth/google/callback`
   - Скопируйте Client ID и Client Secret

5. Добавьте ключи в `.env`:
   ```
   GOOGLE_CLIENT_ID=ваш-client-id
   GOOGLE_CLIENT_SECRET=ваш-client-secret
   ```

## Тестирование

1. Зарегистрируйтесь как ученик
2. Выберите эксперта
3. Выберите предмет
4. Добавьте материал урока (текст или изображение)
5. Дождитесь генерации викторины
6. Пройдите викторину и получите токены!

## Решение проблем

### Проблема: "Доступ запрещен" при создании каталога в Yandex Cloud

**Решения:**
1. Убедитесь, что ваш аккаунт полностью подтвержден (проверьте email)
2. Проверьте, что вы не превысили лимит бесплатных каталогов
3. Попробуйте создать каталог через другой браузер или в режиме инкогнито
4. Очистите кэш браузера и cookies
5. Если вы в организации, запросите права у администратора
6. Используйте существующий каталог, если у вас есть доступ

### Проблема: OAuth не работает

**Для GitHub:**
- Проверьте, что Authorization callback URL совпадает с вашим доменом
- Убедитесь, что приложение опубликовано (для публичного использования)
- Проверьте правильность ID и Secret в `.env`

**Для Google:**
- Убедитесь, что OAuth consent screen настроен
- Проверьте, что redirect URI точно совпадает с настройками
- Убедитесь, что Google+ API включен

### Проблема: Код подтверждения не приходит

- Проверьте консоль сервера - код выводится там (для демо)
- В продакшене настройте отправку email через SMTP
- Проверьте, что код не истек (действителен 10 минут)

### Проблема: YandexART не генерирует изображения

- Убедитесь, что у вас есть доступ к YandexART API
- Проверьте, что Folder ID правильный
- Убедитесь, что API ключ имеет права на использование YandexART
- Проверьте баланс в Yandex Cloud (генерация изображений может быть платной)
- Если YandexART недоступен, приложение будет использовать текстовое описание аватара

### Проблема: YandexGPT 5.1 Pro не работает

- Убедитесь, что модель `yandexgpt-pro/latest` доступна в вашем каталоге
- Проверьте, что у вас есть доступ к этой модели (может требовать специальных прав)
- Если модель недоступна, можно использовать `yandexgpt/latest` (указать в `.env` как `YANDEX_GPT_MODEL=yandexgpt/latest`)
- Проверьте баланс в Yandex Cloud

### Проблема: "401 Unauthorized" или "Unknown api key"

Если вы видите ошибку `401 Client Error: Unauthorized` или `Unknown api key`:

1. **Проверьте правильность API ключа:**
   - Откройте файл `.env` в корне проекта
   - Убедитесь, что `YANDEX_GPT_API_KEY` содержит правильный ключ (без пробелов, кавычек)
   - API ключ должен начинаться с `AQVN...` или `AQAAAA...`

2. **Проверьте правильность Folder ID:**
   - Убедитесь, что `YANDEX_GPT_FOLDER_ID` содержит правильный ID каталога
   - ID каталога должен выглядеть как `b1gxxxxxxxxxxxxxxxx` или `b1xxxxxxxxxxxxxxxx`

3. **Проверьте активность API ключа:**
   - Войдите в [Yandex Cloud Console](https://console.cloud.yandex.ru/)
   - Перейдите в раздел "Сервисные аккаунты"
   - Убедитесь, что API ключ активен и не удален
   - Если ключ удален, создайте новый

4. **Проверьте права API ключа:**
   - Убедитесь, что сервисному аккаунту назначена роль `ai.languageModels.user`
   - Убедитесь, что сервисный аккаунт имеет доступ к каталогу (Folder ID)

5. **Проверьте баланс:**
   - Убедитесь, что в вашем аккаунте Yandex Cloud есть положительный баланс
   - Проверьте лимиты использования API

6. **Пересоздайте API ключ:**
   - Удалите старый API ключ
   - Создайте новый API ключ
   - Обновите значение в файле `.env`
   - Перезапустите приложение

**Важно:** После изменения `.env` файла обязательно перезапустите приложение!

