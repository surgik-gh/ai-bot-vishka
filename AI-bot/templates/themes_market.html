{% extends "base.html" %}

{% block title %}Магазин тем - AI Бот{% endblock %}

{% block content %}
<div class="header">
    <a href="{{ url_for('settings') }}" class="btn-back">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        Назад
    </a>
    <h2>Магазин тем</h2>
    <div></div>
</div>

<div class="container">
    {% for theme_data in themes %}
    {% set theme = theme_data.theme %}
    <div class="card theme-card">
        <div class="theme-preview" style="background: linear-gradient(135deg, {{ theme.bg_primary }} 0%, {{ theme.bg_secondary }} 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
            <h3 style="color: {{ theme.text_primary }};">{{ theme.name }}</h3>
            {% if theme.description %}
            <p style="color: {{ theme.text_secondary }}; font-size: 14px;">{{ theme.description }}</p>
            {% endif %}
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: 600; color: var(--accent);">
                    {% if theme.price == 0 %}
                    Бесплатно
                    {% else %}
                    {{ theme.price }} токенов
                    {% endif %}
                </div>
                <div style="font-size: 12px; color: var(--text-secondary); margin-top: 5px;">
                    Куплено: {{ theme_data.purchases_count }} раз
                </div>
            </div>
            <div>
                {% if theme_data.is_purchased %}
                <button class="btn btn-primary apply-theme" data-theme-id="{{ theme.id }}">Применить</button>
                {% else %}
                <button class="btn btn-primary purchase-theme" data-theme-id="{{ theme.id }}" data-price="{{ theme.price }}">
                    {% if theme.price == 0 %}Применить{% else %}Купить{% endif %}
                </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% endfor %}
    
    {% if themes|length == 0 %}
    <div class="card">
        <p style="text-align: center; color: var(--text-secondary); padding: 40px;">
            Пока нет доступных тем. <a href="{{ url_for('create_theme') }}">Создайте первую!</a>
        </p>
    </div>
    {% endif %}
</div>

<script>
document.querySelectorAll('.purchase-theme, .apply-theme').forEach(btn => {
    btn.addEventListener('click', async function() {
        const themeId = this.dataset.themeId;
        const price = parseInt(this.dataset.price || 0);
        
        if (price > 0 && this.classList.contains('purchase-theme')) {
            if (!confirm(`Купить тему за ${price} токенов?`)) {
                return;
            }
        }
        
        showLoading();
        try {
            const response = await fetch(`/api/themes/purchase/${themeId}`, {
                method: 'POST',
                credentials: 'include'
            });
            const result = await response.json();
            hideLoading();
            
            if (result.success) {
                showNotification(result.message, 'success');
                if (result.tokens !== undefined) {
                    const tokenDisplay = document.getElementById('tokens-count');
                    if (tokenDisplay) {
                        tokenDisplay.textContent = result.tokens;
                    }
                }
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(result.message || 'Ошибка', 'error');
            }
        } catch (error) {
            hideLoading();
            showNotification('Ошибка соединения', 'error');
        }
    });
});
</script>
{% endblock %}

