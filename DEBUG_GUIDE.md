# Руководство по диагностике проблем

## Проблема 1: OpenRouter API не отвечает

### Проверка настроек OpenRouter

1. Проверьте, что API ключ установлен в `.env`:
   ```env
   OPENROUTER_API_KEY=ваш-openrouter-api-ключ
   ```

2. Проверьте импорт в Python:
   ```python
   python -c "from openrouter_api import OpenRouterAPI; print('OK')"
   ```

### Что смотреть в логах

При запуске приложения вы должны увидеть:
- `INFO: Отправка запроса в OpenRouter API` - запрос отправлен
- `INFO: Ответ получен от OpenRouter API` - успешный ответ

Если видите:
- `OpenRouter API error` - проблема с API ключом или подключением
- `ERROR: Не удалось проанализировать материал` - проблема с генерацией

## Проблема 2: Не генерируется аватар

### Проверка настроек Kandinsky

1. Проверьте `.env` файл:
   ```env
   KANDINSKY_API_KEY=ваш-api-key
   KANDINSKY_SECRET_KEY=ваш-secret-key
   ```

2. Убедитесь, что ключи без кавычек и пробелов

3. Проверьте, что ключи активны в [FusionBrain AI](https://fusionbrain.ai/)

### Что смотреть в логах

При создании эксперта вы должны увидеть последовательность:

1. `INFO: Начало генерации эксперта...`
2. `INFO: Генерация промпта эксперта через OpenRouter...`
3. `INFO: Промпт эксперта получен...`
4. `INFO: Генерация описания аватара через OpenRouter...`
5. `INFO: Описание аватара получено...`
6. `INFO: Запуск генерации изображения аватара через Kandinsky...`
7. `INFO: Отправка запроса в Kandinsky API...`
8. `INFO: Kandinsky ответ: Status 200`
9. `INFO: Kandinsky UUID получен...`
10. `INFO: Kandinsky статус (попытка X/30): PROCESSING` или `DONE`
11. `INFO: Kandinsky изображение готово...`

### Возможные проблемы

#### Ошибка: "Kandinsky API ключи не настроены"
- Проверьте `.env` файл
- Убедитесь, что переменные называются правильно: `KANDINSKY_API_KEY` и `KANDINSKY_SECRET_KEY`
- Перезапустите приложение после изменения `.env`

#### Ошибка: "Kandinsky API HTTP Error: 401"
- Неправильные ключи API
- Ключи истекли или неактивны
- Проверьте ключи в личном кабинете FusionBrain

#### Ошибка: "Kandinsky API HTTP Error: 403"
- Недостаточно прав у API ключей
- Проверьте тарифный план

#### Ошибка: "Превышено время ожидания"
- Генерация занимает больше 60 секунд
- Попробуйте еще раз или проверьте статус сервиса Kandinsky

#### Статус: "FAIL"
- Промпт не подходит для генерации
- Проверьте логи для деталей ошибки

### Тестирование Kandinsky API вручную

Можно протестировать API напрямую:

```python
import requests

headers = {
    'X-Key': 'Key ваш-api-key',
    'X-Secret': 'Secret ваш-secret-key'
}

data = {
    'type': 'GENERATE',
    'numImages': 1,
    'width': 1024,
    'height': 1024,
    'generateParams': {
        'query': 'Профессиональный портрет преподавателя'
    }
}

response = requests.post(
    'https://api-key.fusionbrain.ai/key/api/v1/text2image/run',
    headers=headers,
    json=data
)

print(response.status_code)
print(response.json())
```

## Общие рекомендации

1. **Всегда проверяйте логи** - они содержат подробную информацию о каждом шаге
2. **Перезапускайте приложение** после изменения `.env`
3. **Проверяйте формат ключей** - без кавычек, пробелов, правильный префикс
4. **Используйте виртуальное окружение** для изоляции зависимостей

